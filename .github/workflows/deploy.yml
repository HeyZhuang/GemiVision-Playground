name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 117.72.146.138 >> ~/.ssh/known_hosts
        
    - name: Deploy to server
      run: |
        echo "å¼€å§‹éƒ¨ç½²åœ£è¯æ ‘é¡¹ç›®åˆ°æœåŠ¡å™¨..."
        echo "æœåŠ¡å™¨IP: 117.72.146.138"
        echo "åŸŸå: ch-love.online"
        
        # ä½¿ç”¨rsyncåŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨
        rsync -avz --progress \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='*.sh' \
          --exclude='christmas_tree_touch&gesture.html' \
          --exclude='README.md' \
          --exclude='éƒ¨ç½²è¯´æ˜.md' \
          ./ root@117.72.146.138:/var/www/html/
          
        # é…ç½®æœåŠ¡å™¨
        ssh root@117.72.146.138 << 'EOF'
        # åˆ›å»ºç½‘ç«™ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p /var/www/html
        
        # è®¾ç½®æ­£ç¡®çš„æƒé™
        chown -R www-data:www-data /var/www/html
        chmod -R 755 /var/www/html
        
        # åˆ›å»ºNginxé…ç½®æ–‡ä»¶
        cat > /etc/nginx/sites-available/ch-love.online << 'NGINX_CONFIG'
        server {
            listen 80;
            server_name ch-love.online www.ch-love.online 117.72.146.138;
            
            root /var/www/html;
            index index.html index.htm;
            
            # å¯ç”¨gzipå‹ç¼©
            gzip on;
            gzip_vary on;
            gzip_min_length 1024;
            gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
            
            # é™æ€æ–‡ä»¶ç¼“å­˜
            location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
            
            # ä¸»é¡µé¢
            location / {
                try_files $uri $uri/ =404;
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
            }
            
            # é”™è¯¯é¡µé¢
            error_page 404 /index.html;
        }
        NGINX_CONFIG
        
        # å¯ç”¨ç«™ç‚¹
        ln -sf /etc/nginx/sites-available/ch-love.online /etc/nginx/sites-enabled/
        
        # åˆ é™¤é»˜è®¤ç«™ç‚¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        rm -f /etc/nginx/sites-enabled/default
        
        # æµ‹è¯•Nginxé…ç½®
        nginx -t
        
        if [ $? -eq 0 ]; then
            # é‡å¯Nginx
            systemctl reload nginx
            systemctl enable nginx
            echo "Nginxé…ç½®æˆåŠŸï¼"
        else
            echo "Nginxé…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶"
            exit 1
        fi
        
        # æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
        ufw allow 'Nginx Full'
        ufw allow ssh
        
        echo "éƒ¨ç½²å®Œæˆï¼"
        echo "ç½‘ç«™å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š"
        echo "http://ch-love.online"
        echo "http://www.ch-love.online"
        echo "http://117.72.146.138"
        EOF
        
    - name: Verify deployment
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ç½‘ç«™è®¿é—®åœ°å€ï¼š"
        echo "  - http://ch-love.online"
        echo "  - http://www.ch-love.online"
        echo "  - http://117.72.146.138"
        echo ""
        echo "å»ºè®®åç»­é…ç½®SSLè¯ä¹¦ä»¥å¯ç”¨HTTPSè®¿é—®"
